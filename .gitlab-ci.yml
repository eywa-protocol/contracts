services:
  - docker:bind

stages:
  - deploy

deploy:
  stage: deploy
  before_script:
    - docker login -u ${DOCKER_REGISTRY_USER_NAME} -p ${DOCKER_REGISTRY_USER_PASSWORD} registry.digiu.ai
  script:
    - docker run -t --rm -v $(pwd):/app --user builder --add-host=mumbai.testnet.eywa.fi:10.1.0.21 --add-host=huobi.testnet.eywa.fi:10.1.0.21 --add-host=rinkeby.testnet.eywa.fi:10.1.0.21 --add-host=bsc.testnet.eywa.fi:10.1.0.21 registry.digiu.ai/base/eywa-contracts:2 make -C /app eth-testnet-migrate
  only:
    - tags
  tags:
    - docker
  when: manual
  artifacts:
    paths:
        - wrappers/
        - hardhat/helper-hardhat-config.json
        - hardhat/.env
        - hardhat/networks_env

rebuild:
  stage: deploy
  before_script:
    - docker login -u ${DOCKER_REGISTRY_USER_NAME} -p ${DOCKER_REGISTRY_USER_PASSWORD} registry.digiu.ai
  script:
    - docker run -t --rm -v $(pwd):/app --user builder registry.digiu.ai/base/eywa-contracts:2 make -C /app wrappers
  only:
    - tags
  tags:
    - docker
  when: manual
  artifacts:
    paths:
        - wrappers/
        - hardhat/helper-hardhat-config.json
        - hardhat/.env
